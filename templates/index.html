<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7MA出行</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        /* --- 新增的按钮组样式 --- */
        #action-selector {
            display: flex;
            margin-top: 10px;
            margin-bottom: 5px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #e0e0e0;
            width: 500px;
            max-width: 90vw;
        }
        .action-btn {
            flex: 1; /* 让两个按钮平分宽度 */
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
            color: #555;
            background-color: #e9e9e9; /* 非激活状态 */
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            outline: none;
            text-align: center;
        }
        .action-btn.active {
            background-color: #007bff; /* 激活状态 (蓝色) */
            color: white;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        /* --- 按钮组样式结束 --- */

        /* --- ▼▼▼ 新增：手动输入框样式 ▼▼▼ --- */
        #manual-input-container {
            display: flex; /* 放在一行 */
            width: 500px;
            max-width: 90vw;
            margin-top: 5px; /* 保持间距 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #manual-bike-number {
            flex: 1; /* 占据剩余空间 */
            height: 40px; /* "高度窄一点" */
            padding: 0 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-right: none; /* 让按钮无缝连接, 达到 "紧凑" */
            border-radius: 8px 0 0 8px; /* 匹配圆角 */
            box-sizing: border-box; /* 确保高度一致 */
            outline: none;
        }
        #manual-bike-number:focus {
            border-color: #007bff; /* 聚焦时高亮 */
            z-index: 1;
            position: relative;
        }
        #manual-submit-btn {
            height: 40px; /* "高度窄一点" */
            padding: 0 20px;
            font-size: 16px;
            font-weight: bold;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 0 8px 8px 0; /* 匹配圆角 */
            cursor: pointer;
            box-sizing: border-box; /* 确保高度一致 */
            transition: background-color 0.3s;
        }
        #manual-submit-btn:hover {
            background-color: #0056b3;
        }
        /* --- ▲▲▲ 手动输入框样式结束 ▲▲▲ --- */


        #qr-reader {
            width: 500px;
            height: 300px;
            max-width: 90vw;
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
            background-color: #333;
        }
        #qr-reader-results {
            margin-top: 15px;
            font-size: 1.1em;
            color: #333;
            word-break: break-all;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 300px;
            max-width: 90vw;
            text-align: left;
            min-height: 40px;
        }
        #qr-reader-results strong {
            color: #007bff;
        }
        #torch-button {
            margin-top: 5px;
            margin-bottom: 5px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #f0ad4e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none; 
        }
    </style>
</head>
<body>
    <div id="qr-reader"></div>
    <button id="torch-button">打开闪光灯</button>

    <div id="manual-input-container">
        <input type="text" id="manual-bike-number" placeholder="手动输入车号">
        <button id="manual-submit-btn">提 交</button>
    </div>
    <div id="action-selector">
        <button id="btn-lend" class="action-btn active" data-action="lend">借 车</button>
        <button id="btn-back" class="action-btn" data-action="back">还 车</button>
    </div>
    <h2 style="display: flex;margin-top:5px; margin-bottom:5px;">处理结果:</h2>
    <div id="qr-reader-results">请扫描二维码...</div>

    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        document.addEventListener("DOMContentLoaded", (event) => {
            const resultsElement = document.getElementById('qr-reader-results');
            const torchButton = document.getElementById('torch-button');
            const html5QrCode = new Html5Qrcode("qr-reader");

            // --- 新增：获取操作按钮 ---
            const btnLend = document.getElementById('btn-lend');
            const btnBack = document.getElementById('btn-back');

            // --- ▼▼▼ 新增：获取手动输入元素 ▼▼▼ ---
            const manualInput = document.getElementById('manual-bike-number');
            const manualSubmitBtn = document.getElementById('manual-submit-btn');
            // --- ▲▲▲ 新增：获取手动输入元素 ▲▲▲ ---
            
            // --- 状态变量 ---
            let currentActionType = 'lend'; // 默认是 'lend'
            let isTorchOn = false;
            // 用于防止重复提交
            let isProcessing = false; // 是否有请求正在进行
            let lastProcessedRandnum = null; // 上一个 *成功* 处理的号码
            let lastSuccessfulResponse = null; // 上一个成功响应，用于显示

            // --- 新增：为操作按钮绑定点击事件 ---
            btnLend.addEventListener('click', () => {
                if (currentActionType !== 'lend') {
                    currentActionType = 'lend';
                    btnLend.classList.add('active');
                    btnBack.classList.remove('active');
                    console.log('操作切换为: 借车');
                }
            });

            btnBack.addEventListener('click', () => {
                if (currentActionType !== 'back') {
                    currentActionType = 'back';
                    btnBack.classList.add('active');
                    btnLend.classList.remove('active');
                    console.log('操作切换为: 还车');
                }
            });

            // --- ▼▼▼ 新增：手动提交流程 ▼▼▼ ---
            function processManualInput() {
                const bikeNum = manualInput.value.trim();

                // 1. 检查是否为空
                if (!bikeNum) {
                    resultsElement.textContent = "请输入单号。";
                    return;
                }
                
                // 2. 检查是否正在处理 (同 onScanSuccess)
                if (isProcessing) {
                    console.log("正在处理上一个请求，请稍候...");
                    resultsElement.textContent = "正在处理上一个请求，请稍候...";
                    return;
                }

                // 3. 检查是否是同一个号码 (同 onScanSuccess)
                if (bikeNum === lastProcessedRandnum) {
                    console.log(`重复提交: ${bikeNum}，已处理。`);
                    if (lastSuccessfulResponse) {
                        resultsElement.innerHTML = `<strong>[已处理: ${bikeNum}]</strong><br>${lastSuccessfulResponse}`;
                    } else {
                         resultsElement.innerHTML = `<strong>[已处理: ${bikeNum}]</strong><br>请勿重复提交。`;
                    }
                    return; 
                }

                // 4. 开始处理
                isProcessing = true;
                lastProcessedRandnum = bikeNum; // 立即设置，防止重复
                lastSuccessfulResponse = null; // 重置上一个成功响应
                
                resultsElement.innerHTML = `手动提交: <strong>${bikeNum}</strong><br>操作: <strong>${currentActionType === 'lend' ? '借车' : '还车'}</strong><br>正在提交到服务器...`;
                
                // 5. 调用 AJAX
                sendBikeNumber(bikeNum);
                
                // 6. 提交后不清空输入框，方便用户核对
            }

            // 绑定点击事件
            manualSubmitBtn.addEventListener('click', processManualInput);

            // 绑定回车键
            manualInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault(); // 防止意外的表单提交
                    processManualInput();
                }
            });
            // --- ▲▲▲ 手动提交流程结束 ▲▲▲ ---


            /**
             * 异步函数：发送 AJAX (POST) 请求到 /process
             */
            async function sendBikeNumber(bikeNum) {
                const url = '/7ma/process';
                const data = new URLSearchParams();
                data.append('bike_number', bikeNum);
                
                // --- 修改：添加 action_type ---
                data.append('action_type', currentActionType); 
                
                console.log(`正在提交: bike_number=${bikeNum}, action_type=${currentActionType}`);

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: data,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    });

                    if (response.ok) {
                        const responseText = await response.text();
                        resultsElement.innerHTML = `<strong>处理成功 (单号: ${bikeNum} / 操作: ${currentActionType === 'lend' ? '借车' : '还车'}):</strong><br>${responseText}`;
                        // 记录成功的响应
                        lastSuccessfulResponse = responseText;
                    } else {
                        // 服务器返回错误 (如 404, 500)
                        resultsElement.textContent = `服务器错误: ${response.status} ${response.statusText}。请重试。`;
                        // 重置，允许重扫
                        lastProcessedRandnum = null;
                        lastSuccessfulResponse = null;
                    }
                } catch (error) {
                    // 网络错误
                    console.error('Fetch error:', error);
                    resultsElement.textContent = `网络请求失败: ${error.message}。请检查网络并重试。`;
                    // 重置，允许重扫
                    lastProcessedRandnum = null;
                    lastSuccessfulResponse = null;
                } finally {
                    // 无论成功失败，都解除处理中状态
                    isProcessing = false;
                }
            }


            /**
             * 成功扫描后的回调
             */
            function onScanSuccess(decodedText, decodedResult) {
                // 如果上一个请求还在处理中，则忽略所有新的扫描
                if (isProcessing) {
                    console.log("正在处理上一个请求，请稍候...");
                    return;
                }

                let randnum = null;
                
                // 1. 尝试解析扫描到的内容是否为URL
                try {
                    const url = new URL(decodedText);
                    
                    // 2. 检查是否是目标URL
                    if (url.origin + url.pathname === 'http://www.7mate.cn/app.php') {
                        // 3. 提取 randnum 参数
                        randnum = url.searchParams.get('randnum');
                    }
                } catch (e) {
                    // 扫描到的不是一个有效的URL，忽略
                }

                // 4. 判断是否是我们需要的二维码
                if (randnum) {
                    // 5. 检查是否是刚刚成功处理过的同一个号码
                    if (randnum === lastProcessedRandnum) {
                        console.log(`重复扫描: ${randnum}，已处理。`);
                        // (可选) 重新显示上一次的成功结果
                        if (lastSuccessfulResponse) {
                            resultsElement.innerHTML = `<strong>[已处理: ${randnum}]</strong><br>${lastSuccessfulResponse}`;
                        }
                        return; // 不再重复请求
                    }

                    // 6. 这是一个新的、有效的号码，开始处理
                    isProcessing = true;
                    lastProcessedRandnum = randnum; // 立即设置，防止连续扫描
                    lastSuccessfulResponse = null; // 重置上一个成功响应
                    
                    resultsElement.innerHTML = `识别成功: <strong>${randnum}</strong><br>操作: <strong>${currentActionType === 'lend' ? '借车' : '还车'}</strong><br>正在提交到服务器...`;
                    
                    // 7. 调用 AJAX 函数
                    sendBikeNumber(randnum);

                } else {
                    // 扫描到了二维码，但不是我们想要的格式
                    resultsElement.textContent = `扫描到无效二维码。请扫描7mate二维码。`;
                    // 注意：这里我们 *不* 重置 lastProcessedRandnum
                    // 这样即使用户扫描了 [A, B, A]，A也只会被提交一次
                }
            }

            function onScanFailure(error) {
                // 忽略，保持持续扫描
            }

            // --- 闪光灯控制 ---
            torchButton.addEventListener('click', () => {
                isTorchOn = !isTorchOn;
                const constraints = { advanced: [{ torch: isTorchOn }] };
                html5QrCode.applyVideoConstraints(constraints)
                    .then(() => {
                        torchButton.textContent = isTorchOn ? '关闭闪光灯' : '打开闪光灯';
                    })
                    .catch(err => {
                        console.error('切换闪光灯失败:', err);
                        isTorchOn = !isTorchOn; // 回滚状态
                    });
            });

            // --- 启动扫描器 ---
            const config = { 
                fps: 10,
                qrbox: { width: 250, height: 400 }
            };

            resultsElement.textContent = "正在启动后置摄像头...";
            
            html5QrCode.start(
                { facingMode: "environment" }, config, onScanSuccess, onScanFailure
            )
            .then(() => {
                resultsElement.innerHTML = "摄像头已启动，请扫描 <strong>7mate.cn</strong> 二维码。";
                // 检查闪光灯能力
                try {
                    const capabilities = html5QrCode.getRunningTrackCapabilities();
                    if (capabilities && capabilities.torch) {
                        torchButton.style.display = 'block'; // 显示按钮
                    }
                } catch (err) { /* 忽略 */ }
            })
            .catch((err) => {
                console.warn(`后置摄像头启动失败: ${err}`);
                resultsElement.textContent = "后置摄像头失败，尝试默认...";
                // 尝试默认摄像头
                html5QrCode.start({ }, config, onScanSuccess, onScanFailure)
                .then(() => {
                    resultsElement.innerHTML = "摄像头已启动，请扫描 <strong>7mate.cn</strong> 二维码。";
                })
                .catch((err2) => {
                    resultsElement.textContent = `错误：无法启动摄像头。请确保授予权限并使用 https。`;
                });
            });
        });
    </script>

</body>
</html>